
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MiTV — Crónica TV</title>
  <!-- HLS para navegadores sin soporte nativo -->
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.8"></script>
  <style>
    html,body{margin:0;height:100%;background:#000}
    #wrap{position:fixed;inset:0;background:#000}
    video{width:100%;height:100%;display:block;background:#000;outline:none}
    /* Aviso mínimo: sólo si hace falta un gesto */
    #overlay{
      position:fixed;inset:0;display:none;place-items:center;
      background:rgba(0,0,0,.88);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Arial;
      text-align:center;padding:24px
    }
    #overlay.show{display:grid}
    .hint{opacity:.9;max-width:560px}
  </style>
</head>
<body>
  <div id="wrap"><video id="v" autoplay playsinline></video></div>
  <div id="overlay"><div class="hint">Doble-tap / doble-click para activar <b>sonido</b> y <b>pantalla completa</b>.</div></div>

  <script>
  (async () => {
    // ===== Config =====
    const DEFAULT_SRC = "https://g3.vxral-hor.transport.edge-access.net/a09/ngrp:cronicatv_video1-100044_all/cronicatv_video1-100044_720p.m3u8";
    const SRC = new URL(location.href).searchParams.get("src") || DEFAULT_SRC;
    const AUTO_FS_ON_START = true;        // Pedir FS en el arranque
    const INITIAL_MUTED = true;           // Autoplay fiable en móviles
    const VOLUME_KEY = "mitv.v";
    const CONSENT_KEY = "mitv.consent";   // Si una vez diste toque, en futuras visitas intenta sonido auto

    const video = document.getElementById("v");
    const overlay = document.getElementById("overlay");

    // ===== Utils =====
    const sleep = ms => new Promise(r=>setTimeout(r,ms));
    function showOverlay(b=true){ overlay.classList.toggle("show", !!b); }
    async function requestFS(){
      const el = document.documentElement;
      try{
        if(!document.fullscreenElement){
          if(el.requestFullscreen) await el.requestFullscreen();
          else if(el.webkitRequestFullscreen) await el.webkitRequestFullscreen();
          else if(el.msRequestFullscreen) await el.msRequestFullscreen();
        }
      }catch(e){}
    }
    async function play() { try{ await video.play(); return true; }catch(e){ return false; } }
    function getConsent(){ try{ return localStorage.getItem(CONSENT_KEY)==="1"; }catch{return false} }
    function setConsent(){ try{ localStorage.setItem(CONSENT_KEY,"1"); }catch{} }
    function loadVolume(){ try{ const x=+localStorage.getItem(VOLUME_KEY); if(!Number.isNaN(x)) video.volume=Math.min(1,Math.max(0,x)); }catch{} }
    function saveVolume(){ try{ localStorage.setItem(VOLUME_KEY,String(video.volume)); }catch{} }

    // Wake Lock (si existe)
    let wl; async function keepAwake(){ try{ if('wakeLock' in navigator) wl = await navigator.wakeLock.request('screen'); }catch{} }

    // Media Session
    if ('mediaSession' in navigator) {
      navigator.mediaSession.metadata = new MediaMetadata({ title: "Crónica TV — MiTV" });
      navigator.mediaSession.playbackState = 'playing';
      navigator.mediaSession.setActionHandler('play', ()=>video.play());
      navigator.mediaSession.setActionHandler('pause', ()=>video.pause());
    }

    // Estado inicial
    video.muted = INITIAL_MUTED;
    loadVolume();
    keepAwake();

    // Ocultar overlay cuando realmente suene/ande
    const hide = ()=> showOverlay(false);
    video.addEventListener("playing", hide);
    video.addEventListener("volumechange", ()=>{ if(!video.muted) hide(); saveVolume(); });

    // Cargar stream con hls.js o nativo
    function attachHLSErrors(hls){
      hls.on(Hls.Events.ERROR, async (_, data) => {
        if (!data.fatal) return;
        switch (data.type) {
          case Hls.ErrorTypes.NETWORK_ERROR:
            try{ hls.startLoad(); }catch{}
            break;
          case Hls.ErrorTypes.MEDIA_ERROR:
            try{ hls.recoverMediaError(); }catch{}
            break;
          default:
            // Reintento completo
            location.reload();
        }
      });
    }

    async function start(url){
      if (window.Hls && Hls.isSupported()) {
        const hls = new Hls({ lowLatencyMode:true, backBufferLength:60 });
        hls.loadSource(url);
        hls.attachMedia(video);
        attachHLSErrors(hls);
        hls.on(Hls.Events.MANIFEST_PARSED, async ()=>{
          await play();
          if (AUTO_FS_ON_START) await requestFS();
          if (getConsent()) { try{ video.muted=false; }catch{} await play(); }
          else showOverlay(true);
        });
      } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        // iOS / Safari
        video.src = url;
        video.addEventListener("loadedmetadata", async ()=>{
          await play();
          if (AUTO_FS_ON_START) await requestFS();
          if (getConsent()) { try{ video.muted=false; }catch{} await play(); }
          else showOverlay(true);
        }, { once:true });
      } else {
        // Sin soporte: pedimos gesto
        showOverlay(true);
      }
    }

    // Doble-tap / doble-click = consentimiento + sonido + FS
    let lastTap = 0;
    document.addEventListener("pointerdown", async ()=>{
      const now = Date.now();
      const isDT = (now - lastTap) < 400;
      lastTap = now;
      if (isDT || overlay.classList.contains("show")) {
        setConsent();
        try{ video.muted=false; video.volume = Math.max(0.3, video.volume || 1); }catch{}
        await requestFS();
        await play();
        showOverlay(false);
      }
    });

    // Si se pierde foco/FS, reintentar
    document.addEventListener("visibilitychange", async ()=>{
      if (!document.hidden) {
        if (video.paused) await play();
        if (getConsent() && video.muted){ try{ video.muted=false; }catch{} await play(); }
        if (AUTO_FS_ON_START && !document.fullscreenElement) { await sleep(200); await requestFS(); }
      }
    });

    // Arranque
    start(SRC);
  })();
  </script>
</body>
</html>
