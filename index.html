<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mi Web TV</title>
<meta name="description" content="Player IPTV web con HLS e iframe; admite listas M3U/W3U y canales p√∫blicos.">
<style>
  :root{--bg:#0b1020;--panel:#0f172a;--fg:#e2e8f0;--muted:#94a3b8;--accent:#22c55e}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b1020,#111827);color:var(--fg);
       font:15px system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,sans-serif}
  .app{display:grid;grid-template-columns:320px 1fr;grid-template-rows:auto 1fr;min-height:100vh}
  header{grid-column:1/3;display:flex;gap:14px;align-items:center;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.08);background:#0e152b}
  header img{width:40px;height:40px;border-radius:10px}
  header h1{font-size:18px;margin:0}
  header p{margin:0;color:var(--muted)}
  .sidebar{background:var(--panel);border-right:1px solid rgba(255,255,255,.08);display:flex;flex-direction:column;min-height:0}
  .tools{display:flex;gap:8px;flex-wrap:wrap;padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  .tools input,.tools button{border-radius:10px;border:1px solid rgba(255,255,255,.15);padding:9px 10px;background:#0e1830;color:var(--fg)}
  .tools button{cursor:pointer;background:var(--accent);color:#08210f;border:none;font-weight:700}
  .tools .ghost{background:transparent;color:var(--fg);border:1px solid rgba(255,255,255,.2)}
  .search{padding:10px;border-bottom:1px solid rgba(255,255,255,.08)}
  .search input{width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.15);background:#0e1830;color:var(--fg)}
  .list{overflow:auto;padding:8px}
  .group{margin:8px 0}
  .group h3{margin:10px 8px;color:var(--muted);font-size:12px;letter-spacing:.08em;text-transform:uppercase}
  .ch{display:flex;gap:10px;align-items:center;padding:8px;border-radius:10px;cursor:pointer}
  .ch:hover{background:rgba(255,255,255,.06)}
  .ch.active{background:rgba(34,197,94,.18);outline:1px solid rgba(34,197,94,.35)}
  .ch img{width:36px;height:36px;border-radius:8px;object-fit:cover;background:#000}
  .ch .title{font-weight:600}
  .ch .meta{color:var(--muted);font-size:12px}
  .player{display:flex;flex-direction:column;background:radial-gradient(60% 60% at 50% 40%, #0c1430 0%, #080c1a 100%)}
  .display{position:relative;aspect-ratio:16/9;background:#000}
  video, iframe{width:100%;height:100%;display:block;border:0;background:#000}
  .controls{display:flex;flex-wrap:wrap;gap:8px;padding:10px 12px;border-top:1px solid rgba(255,255,255,.08);background:rgba(0,0,0,.15)}
  .btn{appearance:none;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:var(--fg);padding:8px 12px;border-radius:10px;cursor:pointer}
  .btn.accent{border-color:transparent;background:var(--accent);color:#08210f;font-weight:700}
  .now{padding:12px;border-top:1px solid rgba(255,255,255,.08);color:var(--muted)}
  .now b{color:var(--fg)}
  .hint{font-size:12px;color:var(--muted);margin-left:auto;align-self:center}
  @media (max-width:900px){.app{grid-template-columns:1fr;grid-template-rows:auto auto 1fr}.sidebar{order:2}.player{order:3}}
</style>
</head>
<body>
<div class="app">
  <header>
    <img src="https://i.ibb.co/d02C4nhf/LISTA-WISEPLAY-LOGO.png" alt="logo">
    <div>
      <h1>Mi Web TV</h1>
      <p>Player con HLS e IFRAME. Usa solo fuentes con permiso de embeber.</p>
    </div>
  </header>

  <aside class="sidebar">
    <div class="tools">
      <input id="manualName" placeholder="Nombre canal">
      <input id="manualURL" placeholder="URL .m3u8 o IFRAME (YouTube, etc.)">
      <select id="manualType" title="Tipo">
        <option value="hls">HLS (.m3u8)</option>
        <option value="iframe">IFRAME</option>
      </select>
      <button id="addManual">+ Agregar</button>
      <input id="listURL" placeholder="URL de lista .m3u o .w3u">
      <button id="importList" class="ghost">‚¨á Importar</button>
    </div>
    <div class="search">
      <input id="q" type="search" placeholder="Buscar canal...">
    </div>
    <div id="list" class="list"></div>
  </aside>

  <main class="player">
    <div class="display" id="display">
      <!-- Se alterna entre <video> y <iframe> seg√∫n el canal -->
      <video id="video" controls playsinline></video>
    </div>
    <div class="controls">
      <button class="btn accent" id="playPause">‚èØ Reproducir / Pausar</button>
      <button class="btn" id="mute">üîá Silencio</button>
      <button class="btn" id="fs">‚õ∂ Pantalla completa</button>
      <span class="hint">Tip: peg√° .m3u8 o un iframe permitido; tambi√©n import√° .m3u/.w3u</span>
    </div>
    <div class="now" id="now">Selecciona un canal‚Ä¶</div>
  </main>
</div>

<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<script>
// ========= 1) Base de ejemplo (legales) =========
const BASE = [
  { group: "Pluto TV ‚Äì 24/7 Series", channels: [
    { type:"hls", name:"South Park (ES) ‚Ä¢ 24/7", info:"Pluto TV",
      image:"https://imagenes.elpais.com/resizer/sRj5DPzWrRGBkU8ro34WRufp-LE=/1960x1470/",
      url:"https://stitcher.pluto.tv/stitch/hls/channel/628751bb7154a40007168843/master.m3u8" },
    { type:"hls", name:"Bob Esponja (ES) ‚Ä¢ 24/7", info:"Pluto TV",
      image:"https://estaticos-cdn.elperiodico.com/clip/6040f332-9afa-471d-b076-c060ae37450a_alta-libre-aspect-ratio_default_0.jpg",
      url:"https://stitcher.pluto.tv/stitch/hls/channel/5f1aca0b4e448e00075e7c5e/master.m3u8" },
  ]},
  { group: "Ejemplos de IFRAME", channels: [
    // Reemplaza el ID por el de un YouTube Live embebible del due√±o del canal (permitido por YouTube)
    { type:"iframe", name:"Ejemplo YouTube Live", info:"YouTube",
      image:"https://upload.wikimedia.org/wikipedia/commons/e/ef/Youtube_logo.png",
      url:"https://www.youtube.com/embed/5qap5aO4i9A" } // demo (lofi radio)
  ]}
];

// ========= 2) Estado/UI =========
const $q = document.getElementById('q');
const $list = document.getElementById('list');
const $display = document.getElementById('display');
const $video = document.getElementById('video');
const $now = document.getElementById('now');
const $btnPlay = document.getElementById('playPause');
const $btnMute = document.getElementById('mute');
const $btnFs = document.getElementById('fs');

const $manualName = document.getElementById('manualName');
const $manualURL  = document.getElementById('manualURL');
const $manualType = document.getElementById('manualType');
const $listURL    = document.getElementById('listURL');
const $importList = document.getElementById('importList');

let PLAYLIST = JSON.parse(localStorage.getItem('playlist_v2')||'null') || BASE;
let CURRENT = null;
let hls = null;

// ========= 3) Render =========
function createChannelNode(ch, idx, gidx){
  const el = document.createElement('div');
  el.className = 'ch';
  el.dataset.idx = idx; el.dataset.gidx = gidx;
  el.innerHTML = `<img src="${ch.image||''}" alt=""><div><div class="title">${ch.name}</div><div class="meta">${ch.info||ch.type||''}</div></div>`;
  el.onclick = ()=> playChannel(ch, el);
  return el;
}
function renderList(filter=''){
  $list.innerHTML = '';
  const f = filter.trim().toLowerCase();
  PLAYLIST.forEach((group,gidx)=>{
    const groupEl = document.createElement('div'); groupEl.className = 'group';
    const title = document.createElement('h3'); title.textContent = group.group || 'Canales'; groupEl.appendChild(title);
    (group.channels||[]).forEach((ch, idx)=>{
      if(f && !(`${ch.name} ${ch.info||''}`.toLowerCase().includes(f))) return;
      groupEl.appendChild(createChannelNode(ch, idx, gidx));
    });
    if(groupEl.childNodes.length>1) $list.appendChild(groupEl);
  });
}
function setActive(el){
  [...document.querySelectorAll('.ch.active')].forEach(n=>n.classList.remove('active'));
  if(el) el.classList.add('active');
}

// ========= 4) Reproducir (HLS o IFRAME) =========
function clearPlayer(){
  // elimino iframe si existe
  const oldIframe = $display.querySelector('iframe');
  if(oldIframe) oldIframe.remove();
  // reinicio video/hls
  if (hls) { try{hls.destroy();}catch{} hls=null; }
  $video.pause(); $video.removeAttribute('src'); $video.load();
}
function playHLS(url){
  if ($video.canPlayType('application/vnd.apple.mpegurl')) {
    $video.src = url;
  } else if (window.Hls && Hls.isSupported()) {
    hls = new Hls({ maxBufferLength: 60, enableWorker: true });
    hls.loadSource(url);
    hls.attachMedia($video);
    hls.on(Hls.Events.ERROR, (evt, data) => {
      if (data.fatal) {
        switch (data.type) {
          case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
          case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
          default: hls.destroy(); break;
        }
      }
    });
  } else {
    alert('Tu navegador no soporta HLS. Prob√° Safari/iOS o Chrome/Firefox/Edge.');
    return;
  }
  $video.play().catch(()=>{});
}
function playIFRAME(url){
  const iframe = document.createElement('iframe');
  iframe.allow = "autoplay; encrypted-media; picture-in-picture";
  iframe.referrerPolicy = "no-referrer-when-downgrade";
  iframe.src = url;
  $display.appendChild(iframe);
}
function playChannel(ch, el){
  setActive(el); CURRENT = ch; clearPlayer();
  $now.innerHTML = `<b>Reproduciendo:</b> ${ch.name} <span style="color:#94a3b8">(${ch.info||ch.type||'Canal'})</span>`;
  if(ch.type === 'iframe'){ playIFRAME(ch.url); }
  else { playHLS(ch.url); }
}

// ========= 5) B√∫squeda & Controles =========
$q.addEventListener('input', e=> renderList(e.target.value));
$btnPlay.onclick = ()=>{ if($video.offsetParent !== null){ if($video.paused) $video.play(); else $video.pause(); } };
$btnMute.onclick = ()=>{ if($video.offsetParent !== null){ $video.muted = !$video.muted; $btnMute.textContent = $video.muted ? 'üîä Sonido' : 'üîá Silencio'; } };
$btnFs.onclick = ()=>{ const el = $display; if (el.requestFullscreen) el.requestFullscreen(); };

// ========= 6) Agregar manual (HLS o IFRAME) =========
$addManual.onclick = ()=>{
  const name = ($manualName.value||'Canal').trim();
  const url  = ($manualURL.value||'').trim();
  const type = $manualType.value;
  if(type==='hls' && !/^https?:\/\/.+\.m3u8(\?.*)?$/i.test(url)) return alert('URL HLS inv√°lida (.m3u8).');
  if(type==='iframe' && !/^https?:\/\/.+/i.test(url)) return alert('URL de iframe inv√°lida.');
  if(!PLAYLIST[0]) PLAYLIST[0] = { group:'Mis canales', channels:[] };
  PLAYLIST[0].channels.unshift({ type, name, url, info:(type==='hls'?'HLS':'IFRAME'), image:'' });
  localStorage.setItem('playlist_v2', JSON.stringify(PLAYLIST));
  $manualName.value=''; $manualURL.value='';
  renderList($q.value);
};

// ========= 7) Importar listas .m3u / .w3u =========
async function parseM3U(text){
  const lines = text.split(/\r?\n/);
  const out = [];
  for(let i=0;i<lines.length;i++){
    const l = lines[i].trim();
    if(l.startsWith('#EXTINF')){
      const title = l.split(',').pop().trim() || 'Canal';
      const url = (lines[i+1]||'').trim();
      if(/^https?:\/\/.+\.m3u8(\?.*)?$/i.test(url)) out.push({ type:'hls', name:title, url, info:'M3U' });
      // si la m3u apunta a otra lista, no la seguimos (solo streams directos)
    }
  }
  return out.length ? [{ group:'Importado (M3U)', channels: out }] : [];
}
async function parseW3U(text){
  try{
    const json = JSON.parse(text);
    const groups = (json.groups||json||[]);
    const mapped = groups.map(g=>({
      group: g.name || g.nombre || 'Grupo',
      channels: (g.stations||g.estaciones||[]).map(s=>{
        const name = s.name || s.nombre || 'Canal';
        const url  = s.url; const img = s.image || s.imagen || '';
        // Detecto si es HLS o IFRAME
        if(/^https?:\/\/.+\.m3u8(\?.*)?$/i.test(url)) return { type:'hls', name, url, image: img, info:'W3U' };
        if(/^https?:\/\//i.test(url)) return { type:'iframe', name, url, image: img, info:'W3U IFRAME' };
        return null;
      }).filter(Boolean)
    }));
    return mapped;
  }catch{ return []; }
}
$importList.onclick = async ()=>{
  const url = ($listURL.value||'').trim();
  if(!/^https?:\/\//i.test(url)) return alert('Peg√° la URL de una lista .m3u o .w3u');
  try{
    const res = await fetch(url);
    const text = await res.text();
    let imported = [];
    if(text.trim().startsWith('#EXTM3U') || text.includes('#EXTINF')) imported = await parseM3U(text);
    else imported = await parseW3U(text);
    if(!imported.length) return alert('No pude interpretar la lista.');
    PLAYLIST = [...imported, ...PLAYLIST];
    localStorage.setItem('playlist_v2', JSON.stringify(PLAYLIST));
    renderList($q.value);
    alert('Lista importada ‚úî');
  }catch(e){
    alert('Error al descargar la lista (CORS / red / formato).');
  }
};

// ========= 8) Primera carga =========
renderList();
const first = document.querySelector('.ch'); if(first) first.click();
</script>
</body>
</html>
